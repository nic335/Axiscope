<html>
  <title>Axiscope</title>

  <head>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    >
    </script>

    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
      rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
      crossorigin="anonymous"
    >

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script 
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
      crossorigin="anonymous"
    >
    </script>

    <script>var printer_url = "{{ printer_url() }}";</script>
    <script src="./js/index.js"></script>
    <script src="./js/camera.js"></script>
    <link rel="stylesheet" href="./css/camera.css">
  </head>

  <body data-bs-theme="dark">
    <p>add gcode sender</p>

    <div class="container text-center">
      <div class="row">
        <!-- ----------- body.jinja---------------- -->
        <div class="col p-3">
        <div class="border border-secondary-subtle rounded bg-body-tertiary p-2">
            <div class="row p-2 pb-2">
                <div id="camContainer" class="img-overlay-wrap">
                  <img id="zoom-image" src="http://192.168.2.37/webcam?action=stream" width="800"/>
                  <svg viewBox="0 0 200 200">
                    <circle cx="100" cy="75" r="50" stroke="red" stroke-width="0.25" fill="none"/>
                    <line x1="100" y1="15" x2="100" y2="135" stroke="red" stroke-width="0.25" />
                    <line x1="40" y1="75" x2="160" y2="75" stroke="red" stroke-width="0.25" />
                  </svg>
                </div>
                <div class="row p-2">
                  <div class="col-1">
                    <i class="bi bi-zoom-out"></i>
                  </div>
                  <div class="col-10">
                    <input type="range" class="form-range" min="0" max="400" id="zoom-range">
                  </div>
                  <div class="col-1">
                    <i class="bi bi-zoom-in"></i>
                  </div>
                </div>
              
                <div class="row p-2">
                  <div class="col-1">
                    <i class="bi bi-brightness-low"></i>
                  </div>
                  <div class="col-10">
                    <input type="range" class="form-range" min="0" max="400" id="contrast-range">
                  </div>
                  <div class="col-1">
                    <i class="bi bi-brightness-high"></i>
                  </div>
                </div>
            </div>
                <!-- -------------------------- positioning ------------------- -->
            <div id="positioning">
                <div class="row justify-content-center">
                  <ul class="list-group list-group-horizontal-sm justify-content-center pb-2">
                    <li class="list-group-item"><span>X: </span><span id="pos-x">0.0</span></li>
                    <li class="list-group-item"><span>Y: </span><span id="pos-y">0.0</span></li>
                    <li class="list-group-item"><span>Z: </span><span id="pos-z">0.0</span></li>
                  </ul>
                </div>
              
                <div class="row justify-content-center pb-1">
                  {# <button type="button" class="btn btn-sm btn-secondary border w-50 ps-5 pe-5" id="capture-pos">CAPTURE CURRENT POSITION</button> #}
                </div>
              
                <div class="row">
                  <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Homing Toolbar">
                    <div class="btn-group btn-group-sm ps-5 pe-5 pb-1" role="group" aria-label="">
                      <button type="button" class="btn btn-danger border" id="home-all" data-homed="false" data-url="{{ printer_url('/printer/gcode/script?script=G28') }}">HOME ALL</button>
                      <button type="button" class="btn btn-danger border" id="qgl" data-qgl="false" data-url="{{ printer_url('/printer/gcode/script?script=QUAD_GANTRY_LEVEL') }}">QGL</button>
                      <button type="button" class="btn btn-danger border" id="disable-motors" data-motoron="false" data-url="{{ printer_url('/printer/gcode/script?script=M84') }}">DISABLE</button>
                    </div>
                  </div>
                </div>
                <div id="BouncePositionBar"></div>
                <div id="BigPositionBar"></div>
                <script>
                    $(document).ready(function () {
                        printerIp = '192.168.2.37'
                        path = '/webcam?action=stream'

                        const bouncesComands = [
                            'SAVE_GCODE_STATE NAME=bounce_move',
                            'G91',
                            '-bounce-',
                            'RESTORE_GCODE_STATE NAME=bounce_move'
                        ];

                        function ComandsUrl(axis, value) {
                            url = "";
                            bounce = -(value + .5);
                            move = value;
                            $.each(bouncesComands,function(k,comand){
                                if(comand == '-bounce-')
                                    url += 'G0 '+axis+bounce+ '%0AG0 '+axis+move+'%0AG';
                                else
                                    url += comand +"%0A";
                            });
                            return url;
                        }
                        
                        const bounceMove = (axis, value) => `http://${printerIp}/`+ComandsUrl(axis,value);
                        //http://192.168.2.37/printer/gcode/script?script=SAVE_GCODE_STATE NAME=bounce_move%0AG91%0AG0 X-1.01 F500%0AG0 X1 F500%0ARESTORE_GCODE_STATE NAME=bounce_move
                        const printerUrl = (path) => `http://${printerIp}${path}`;
                        

                        const $container = $("#BouncePositionBar");

                        const axes = ["X", "Y"];
                        axes.forEach(axis => {
                            const $row = $('<div class="row pb-1"></div>');
                            const $toolbar = $('<div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Movement Toolbar"></div>');
                            const $btnGroup = $('<div class="btn-group btn-group-sm ps-5 pe-5" role="group"></div>');

                            [-0.01, -0.05, -0.1, -0.5].forEach(value => {
                                $('<button>', {
                                    type: "button",
                                    class: "btn btn-secondary border",
                                    "data-url": bounceMove(axis, value),
                                    text: value.toFixed(2)
                                }).appendTo($btnGroup);
                            });

                            $('<button>', {
                                type: "button",
                                class: "btn btn-dark border border-dark",
                                "data-url": printerUrl(`/printer/gcode/script?script=G28${axis}`),
                                id: `home-fine-${axis.toLowerCase()}`,
                                text: axis
                            }).appendTo($btnGroup);

                            [0.5, 0.1, 0.05, 0.01].forEach(value => {
                                $('<button>', {
                                    type: "button",
                                    class: "btn btn-secondary border",
                                    "data-url": bounceMove(axis, value),
                                    text: `+${value.toFixed(2)}`
                                }).appendTo($btnGroup);
                            });

                            $toolbar.append($btnGroup);
                            $row.append($toolbar);
                            $container.append($row);
                        });

                        const $containerBigPos = $("#BigPositionBar");

                        const axesBigPos = ["X", "Y", "Z"];
                        axes.forEach(axis => {
                            const $row = $('<div class="row pb-1"></div>');
                            const $toolbar = $('<div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Movement Toolbar"></div>');
                            const $btnGroup = $('<div class="btn-group btn-group-sm ps-5 pe-5" role="group"></div>');

                            [-50, -10, -5, -1].forEach(value => {
                                $('<button>', {
                                    type: "button",
                                    class: "btn btn-secondary border",
                                    "data-url": bounceMove(axis, value),
                                    text: value.toFixed(2)
                                }).appendTo($btnGroup);
                            });

                            $('<button>', {
                                type: "button",
                                class: "btn btn-dark border border-dark",
                                "data-url": printerUrl(`/printer/gcode/script?script=G28${axis}`),
                                id: `home-fine-${axis.toLowerCase()}`,
                                text: axis
                            }).appendTo($btnGroup);

                            [1, 5, 25, 50].forEach(value => {
                                $('<button>', {
                                    type: "button",
                                    class: "btn btn-secondary border",
                                    "data-url": bounceMove(axis, value),
                                    text: `+${value.toFixed(2)}`
                                }).appendTo($btnGroup);
                            });

                            $toolbar.append($btnGroup);
                            $row.append($toolbar);
                            $container.append($row);
                        });
                    });
                </script>
                {% for axis in ["X", "Y"] %}
                  <div class="row pb-1">
                    <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Movement Toolbar">
                      <div class="btn-group btn-group-sm ps-5 pe-5" role="group" aria-label="">
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, -0.01) }}">-0.01</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, -0.05) }}">-0.05</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, -0.1)  }}">-0.10</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, -0.5)  }}">-0.50</button>
                        <button type="button" class="btn btn-dark border border-dark" data-url="{{ printer_url('/printer/gcode/script?script=G28') + axis }}" id="home-fine-{{ axis|lower }}">{{ axis }}</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, 0.5)   }}">+0.50</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, 0.10)  }}">+0.10</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, 0.05)  }}">+0.05</button>
                        <button type="button" class="btn btn-secondary border" data-url="{{ bounce_move_url(axis, 0.01)  }}">+0.01</button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              
                <div class="row pt-3 justify-content-center">
                  {% for axis in ["X", "Y", "Z"] %}
                    <div class="row pb-1 ">
                      <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Movement Toolbar">
                        <div class="btn-group btn-group-sm ps-5 pe-5" role="group" aria-label="">
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, -1)   }}">-1</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, -5)   }}">-5</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, -10)  }}">-10</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, -50)  }}">-50</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, -100) }}">-100</button>
                          <button type="button" class="btn btn-dark border border-dark" data-url="{{ printer_url('/printer/gcode/script?script=G28') + axis }}" id="home-course-{{ axis|lower }}">{{ axis }}</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, 100)  }}">+100</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, 50)   }}">+50</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, 10)   }}">+10</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, 5)    }}">+5</button>
                          <button type="button" class="btn btn-secondary border" data-url="{{ course_move_url(axis, 1)    }}">+1</button>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- -------------------------- positioning ------------------- -->
              
        </div>
        </div>

        {% include "tools.jinja" %}

        <!-- --------------------------- -->
      </div>
    </div>
  </body>

  <footer></footer>
</html>